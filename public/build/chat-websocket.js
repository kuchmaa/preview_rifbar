class t{constructor(e={}){this.pusher=null,this.conversationChannel=null,this.operatorChannel=null,this.conversationId=null,this.isOperator=e.isOperator||!1,this.userId=e.userId||null,this.pusherConfig=e.pusher||{},this.callbacks={onMessageReceived:e.onMessageReceived||(()=>{}),onConversationStatusChanged:e.onConversationStatusChanged||(()=>{}),onOperatorAssigned:e.onOperatorAssigned||(()=>{}),onConnectionError:e.onConnectionError||(()=>{})},this.init()}init(){var e;if(!this.pusherConfig.key)return console.warn("Pusher key missing, falling back to HTTP polling"),!1;try{const n=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1";console.log("WebSocket config:",{key:this.pusherConfig.key,cluster:this.pusherConfig.cluster,isLocalSoketi:n,hostname:window.location.hostname});const o={authEndpoint:"/broadcasting/auth",auth:{headers:{"X-CSRF-TOKEN":(e=document.querySelector('meta[name="csrf-token"]'))==null?void 0:e.getAttribute("content"),Accept:"application/json"}}};return n?(o.wsHost=window.location.hostname,o.wsPort=6001,o.wssPort=6001,o.forceTLS=!1,o.encrypted=!1,o.disableStats=!0,o.enabledTransports=["ws"],o.cluster="mt1",o.activityTimeout=3e4,o.pongTimeout=6e3,o.unavailableTimeout=1e4,console.log("Using local Soketi configuration:",o)):(o.cluster=this.pusherConfig.cluster,o.encrypted=!0,o.forceTLS=!0,console.log("Using external Pusher configuration:",o)),console.log("Creating Pusher instance with key:",this.pusherConfig.key),console.log("Pusher options:",JSON.stringify(o,null,2)),this.pusher=new Pusher(this.pusherConfig.key,o),this.pusher.connection.bind("connected",()=>{console.log("Connected to Pusher")}),this.pusher.connection.bind("error",s=>{console.error("Pusher connection error:",s),this.callbacks.onConnectionError(s)}),this.pusher.connection.bind("connecting",()=>{console.log("Connecting to WebSocket...")}),this.pusher.connection.bind("disconnected",()=>{console.log("Disconnected from WebSocket")}),this.pusher.connection.bind("failed",()=>{console.error("WebSocket connection failed")}),this.pusher.connection.bind("state_change",s=>{console.log(`WebSocket state changed: ${s.previous} â†’ ${s.current}`)}),!0}catch(n){return console.error("Failed to initialize Pusher:",n),this.callbacks.onConnectionError(n),!1}}subscribeToConversation(e){if(console.log("ðŸ”” Attempting to subscribe to conversation:",e),!this.pusher){console.error("âŒ Cannot subscribe: Pusher not initialized");return}if(this.conversationId===e){console.log("âœ… Already subscribed to conversation:",e);return}this.unsubscribeFromConversation(),this.conversationId=e;const n=`chat.conversation.${e}`;console.log("ðŸ“¡ Subscribing to channel:",n);try{this.conversationChannel=this.pusher.subscribe(n),this.conversationChannel.bind("message.sent",o=>{this.callbacks.onMessageReceived(o.message,o.conversation)}),this.conversationChannel.bind("conversation.status.updated",o=>{this.callbacks.onConversationStatusChanged(o.conversation)}),this.conversationChannel.bind("operator.assigned",o=>{this.callbacks.onOperatorAssigned(o.conversation,o.operator)}),this.conversationChannel.bind("pusher:subscription_succeeded",()=>{console.log("âœ… Successfully subscribed to conversation channel:",n)}),this.conversationChannel.bind("pusher:subscription_error",o=>{console.error("âŒ Failed to subscribe to conversation channel:",o),this.callbacks.onConnectionError(o)})}catch(o){console.error("Failed to subscribe to conversation:",o),this.callbacks.onConnectionError(o)}}subscribeToOperators(){if(console.log("ðŸ”” Attempting to subscribe to operators channel...",{hasPusher:!!this.pusher,isOperator:this.isOperator,hasOperatorChannel:!!this.operatorChannel}),!this.pusher||!this.isOperator||this.operatorChannel){console.log("âŒ Cannot subscribe to operators channel:",{pusher:!!this.pusher,isOperator:this.isOperator,alreadySubscribed:!!this.operatorChannel});return}try{console.log("ðŸ“¡ Subscribing to chat.operators channel..."),this.operatorChannel=this.pusher.subscribe("chat.operators"),this.operatorChannel.bind("message.sent",e=>{console.log("ðŸ“¡ Received message.sent event on operators channel:",e),console.log("ðŸ” Message details:",{conversation_id:e.conversation.id,client_type:e.conversation.client_type,current_conversation:this.conversationId,will_handle:e.conversation.id!==this.conversationId}),e.conversation.id!==this.conversationId&&this.callbacks.onMessageReceived(e.message,e.conversation)}),this.operatorChannel.bind("conversation.status.updated",e=>{this.callbacks.onConversationStatusChanged(e.conversation)}),this.operatorChannel.bind("pusher:subscription_succeeded",()=>{console.log("âœ… Successfully subscribed to operators channel: chat.operators"),console.log("ðŸŽ¯ Ready to receive events: message.sent, conversation.status.updated, operator.assigned")})}catch(e){console.error("Failed to subscribe to operators channel:",e),this.callbacks.onConnectionError(e)}}unsubscribeFromConversation(){var e;this.conversationChannel&&((e=this.pusher)==null||e.unsubscribe(`chat.conversation.${this.conversationId}`),this.conversationChannel=null,this.conversationId=null)}unsubscribeFromOperators(){var e;this.operatorChannel&&((e=this.pusher)==null||e.unsubscribe("chat.operators"),this.operatorChannel=null)}disconnect(){this.unsubscribeFromConversation(),this.unsubscribeFromOperators(),this.pusher&&(this.pusher.disconnect(),this.pusher=null)}isConnected(){return this.pusher&&this.pusher.connection.state==="connected"}getConnectionState(){return this.pusher?this.pusher.connection.state:"disconnected"}}window.ChatWebSocket=t;
