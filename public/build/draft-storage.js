class l{constructor(){this.storageKey="business_order_draft",this.autoSaveInterval=1e3,this.autoSaveTimer=null,this.isFormSubmitting=!1,this.storageAvailable=!1,this.checkStorageAvailability(),this.init()}checkStorageAvailability(){try{const t="duma_storage_test";localStorage.setItem(t,"test"),localStorage.removeItem(t),this.storageAvailable=!0,console.log("DraftStorage: localStorage is available")}catch(t){this.storageAvailable=!1,console.error("DraftStorage: localStorage is not available:",t),this.showStorageWarning()}}showStorageWarning(){const t=document.createElement("div");t.className="alert alert-warning",t.style.cssText="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;",t.innerHTML=`
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Draft saving disabled</strong><br>
                    <small>Please enable cookies/localStorage to save form drafts</small>
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `,document.body.appendChild(t),setTimeout(()=>{t.parentElement&&t.remove()},1e4)}init(){const t=window.location.pathname;if(console.log("DraftStorage: Current path:",t),!t.includes("/business/orders/create")){console.log("DraftStorage: Not on order creation page, skipping initialization");return}if(console.log("DraftStorage: Initializing on order creation page"),console.log("DraftStorage: Storage available:",this.storageAvailable),!this.storageAvailable){console.log("DraftStorage: Skipping initialization due to unavailable storage");return}this.addDraftManagementUI(),this.setupAutoSave(),this.setupFormSubmitHandler(),this.loadDraftDataWithRetries(),t.includes("create-manual")&&(this.setupDynamicElementsHandler(),setTimeout(()=>{this.ensureInitialParcel()},1e3))}getStorageKey(){return window.location.pathname.includes("create-manual")?`${this.storageKey}_manual`:`${this.storageKey}_products`}collectFormData(){const t={},e=document.querySelector("form");if(!e)return console.log("DraftStorage: No form found"),null;const o=document.querySelectorAll("input, select, textarea");return e.querySelectorAll("input, select, textarea"),o.forEach(r=>{if(r.name&&r.type!=="submit"&&r.type!=="button"&&r.type!=="hidden"){let s;r.type==="checkbox"||r.type==="radio"?s=r.checked:(r.type==="select-one"||r.type,s=r.value),t[r.name]=s}}),t._timestamp=new Date().toISOString(),t._page=window.location.pathname,t}saveDraft(){if(!(!this.storageAvailable||this.isFormSubmitting))try{const t=this.collectFormData();if(!t)return;const e=this.getStorageKey();localStorage.setItem(e,JSON.stringify(t)),this.showDraftSavedIndicator()}catch(t){console.warn("DraftStorage: Failed to save draft:",t),this.storageAvailable=!1,this.showStorageWarning()}}loadDraftDataWithRetries(){let t=0;const e=5,o=[100,500,1e3,2e3,3e3],a=()=>{if(console.log(`DraftStorage: Loading attempt ${t+1}/${e}`),this.loadDraftData()){console.log("DraftStorage: Successfully loaded draft data");return}t++,t<e?setTimeout(a,o[t-1]):console.log("DraftStorage: Failed to load draft data after all attempts")};a()}loadDraftData(){if(!this.storageAvailable)return console.log("DraftStorage: Storage not available, skipping load"),!1;try{const t=this.getStorageKey(),e=localStorage.getItem(t);if(console.log("DraftStorage: Storage key:",t),console.log("DraftStorage: Saved data exists:",!!e),!e)return!1;const o=JSON.parse(e);if(console.log("DraftStorage: Parsed form data:",o),o._timestamp){const r=new Date(o._timestamp);if((new Date-r)/(1e3*60*60)>24)return console.log("DraftStorage: Data too old, clearing"),this.clearDraft(),!1}return this.restoreFormData(o)?(this.showDraftLoadedMessage(),!0):!1}catch(t){return console.warn("DraftStorage: Failed to load draft:",t),this.storageAvailable=!1,this.showStorageWarning(),!1}}restoreFormData(t){console.log("DraftStorage: Restoring form data:",t);let e=0;const o=Object.keys(t).filter(a=>!a.startsWith("_")).length;return Object.keys(t).forEach(a=>{if(a.startsWith("_"))return;const r=document.querySelectorAll(`[name="${a}"]`);if(r.length===0){console.log(`DraftStorage: Element not found for name: ${a}`);return}r.forEach(s=>{try{s.type==="checkbox"||s.type==="radio"?s.checked=t[a]:s.type==="select-one"||s.type==="select-multiple"?(s.value=t[a],s.value!==t[a]&&t[a]&&s.querySelectorAll("option").forEach(i=>{(i.text===t[a]||i.value===t[a])&&(i.selected=!0)})):s.value=t[a],s.dispatchEvent(new Event("change",{bubbles:!0})),s.dispatchEvent(new Event("input",{bubbles:!0})),e++,console.log(`DraftStorage: Restored ${a} = ${t[a]}`)}catch(n){console.warn(`DraftStorage: Failed to restore value for ${a}:`,n)}})}),console.log(`DraftStorage: Restored ${e}/${o} fields`),setTimeout(()=>{this.restoreFormDataSecondPass(t)},1e3),e>0}restoreFormDataSecondPass(t){Object.keys(t).forEach(e=>{if(e.startsWith("_"))return;document.querySelectorAll(`[name="${e}"]`).forEach(a=>{if(!a.value||a.type==="checkbox"&&!a.checked)try{a.type==="checkbox"||a.type==="radio"?a.checked=t[e]:a.value=t[e],a.dispatchEvent(new Event("change",{bubbles:!0}))}catch{}})})}clearDraft(){if(!this.storageAvailable){console.log("DraftStorage: Storage not available, skipping clear");return}try{localStorage.removeItem(this.getStorageKey()),console.log("DraftStorage: Draft cleared successfully")}catch(t){console.warn("DraftStorage: Failed to clear draft:",t)}}showDraftClearedMessage(){const t=document.createElement("div");t.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            font-size: 14px;
            font-weight: 500;
            animation: slideInRight 0.3s ease-out;
        `,t.textContent="âœ“ Draft cleared - form submitted successfully";const e=document.createElement("style");e.textContent=`
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `,document.head.appendChild(e),document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideOutRight 0.3s ease-in",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),e.parentNode&&e.parentNode.removeChild(e)},300)},3e3)}setupAutoSave(){const t=document.querySelector("form");if(!t){console.log("DraftStorage: No form found for auto-save setup");return}if(t.hasAttribute("data-draft-listeners")){console.log("DraftStorage: Auto-save listeners already set up");return}console.log("DraftStorage: Setting up auto-save listeners"),t.addEventListener("input",()=>{this.debouncedSave()}),t.addEventListener("change",()=>{this.debouncedSave()}),document.addEventListener("input",e=>{e.target.name&&(e.target.name.includes("parcels[")||e.target.name.includes("items["))&&this.debouncedSave()}),document.addEventListener("change",e=>{e.target.name&&(e.target.name.includes("parcels[")||e.target.name.includes("items["))&&this.debouncedSave()}),t.setAttribute("data-draft-listeners","true"),this.addDraftManagementUI()}debouncedSave(){clearTimeout(this.autoSaveTimer),this.autoSaveTimer=setTimeout(()=>{this.saveDraft()},this.autoSaveInterval)}setupFormSubmitHandler(){const t=document.querySelector("form");if(!t)return;t.addEventListener("submit",r=>{console.log("DraftStorage: Form submit detected, clearing draft"),this.isFormSubmitting=!0,this.clearDraft(),this.showDraftClearedMessage()}),t.querySelectorAll('button[type="submit"], input[type="submit"]').forEach(r=>{r.addEventListener("click",s=>{const n=r.textContent||r.value||"";(n.toLowerCase().includes("create")||n.toLowerCase().includes("submit"))&&(console.log("DraftStorage: Create Order button clicked, preparing to clear draft"),this.isFormSubmitting=!0,setTimeout(()=>{this.clearDraft(),this.showDraftClearedMessage()},50))})}),document.querySelectorAll("#create-order-btn, #submit-order-btn, .create-order-btn, .submit-order-btn").forEach(r=>{r.addEventListener("click",()=>{console.log("DraftStorage: Create/Submit Order button clicked (by ID/class)"),this.isFormSubmitting=!0,this.clearDraft(),this.showDraftClearedMessage()})}),document.querySelectorAll("button").forEach(r=>{const s=(r.textContent||r.innerText||"").toLowerCase();(s.includes("create order")||s.includes("submit order"))&&r.addEventListener("click",()=>{console.log("DraftStorage: Create/Submit Order button clicked (by text content)"),this.isFormSubmitting=!0,this.clearDraft(),this.showDraftClearedMessage()})})}addDraftManagementUI(){const t=document.querySelector("form");if(!t)return;const e=document.createElement("div");e.className="draft-management-panel",e.innerHTML=`
            <div class="alert alert-info" style="margin-bottom: 20px; display: none;" id="draft-status">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-save"></i>
                        <span id="draft-message">Draft saved automatically</span>
                        <small id="draft-timestamp" class="text-muted ml-2"></small>
                    </div>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-primary mr-2" id="restore-draft-btn">
                            <i class="fas fa-upload"></i> Restore Draft
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="clear-draft-btn">
                            <i class="fas fa-trash"></i> Clear Draft
                        </button>
                    </div>
                </div>
            </div>
        `,t.insertBefore(e,t.firstChild);const o=document.getElementById("clear-draft-btn");o&&o.addEventListener("click",()=>{confirm("Are you sure you want to clear the saved draft? This action cannot be undone.")&&(this.clearDraft(),this.hideDraftStatus(),t.reset())});const a=document.getElementById("restore-draft-btn");a&&a.addEventListener("click",()=>{this.loadDraftData()})}showDraftSavedIndicator(){const t=document.getElementById("draft-status"),e=document.getElementById("draft-message"),o=document.getElementById("draft-timestamp");t&&e&&o&&(e.textContent="Draft saved automatically",o.textContent=`Last saved: ${new Date().toLocaleTimeString()}`,t.style.display="block",t.className="alert alert-success",setTimeout(()=>{t.className="alert alert-info"},3e3))}showDraftLoadedMessage(){const t=document.getElementById("draft-status"),e=document.getElementById("draft-message"),o=document.getElementById("draft-timestamp");t&&e&&o&&(e.innerHTML='<i class="fas fa-upload"></i> Draft data loaded from previous session',o.textContent="",t.style.display="block",t.className="alert alert-warning",setTimeout(()=>{t.className="alert alert-info",e.textContent="Draft saved automatically"},5e3))}hideDraftStatus(){const t=document.getElementById("draft-status");t&&(t.style.display="none")}hasDraft(){try{return localStorage.getItem(this.getStorageKey())!==null}catch{return!1}}getDraftInfo(){try{const t=localStorage.getItem(this.getStorageKey());if(!t)return null;const e=JSON.parse(t);return{timestamp:e._timestamp,page:e._page,fieldsCount:Object.keys(e).filter(o=>!o.startsWith("_")).length}}catch{return null}}setupDynamicElementsHandler(){const t=new MutationObserver(o=>{o.forEach(a=>{a.type==="childList"&&a.addedNodes.forEach(r=>{r.nodeType===Node.ELEMENT_NODE&&r.querySelectorAll("input, select, textarea").length>0&&setTimeout(()=>{this.tryRestoreForNewElements()},100)})})}),e=document.querySelector("form");e&&t.observe(e,{childList:!0,subtree:!0})}tryRestoreForNewElements(){try{const t=localStorage.getItem(this.getStorageKey());if(!t)return;const e=JSON.parse(t);this.restoreFormDataSecondPass(e)}catch(t){console.warn("Failed to restore data for new elements:",t)}}ensureInitialParcel(){const t=document.getElementById("add-parcel-btn"),e=document.getElementById("parcels-container");if(console.log("DraftStorage: Checking for initial parcel"),console.log("DraftStorage: Add parcel button found:",!!t),console.log("DraftStorage: Parcels container found:",!!e),t&&e){const o=e.children.length;console.log(`DraftStorage: Found ${o} existing parcels`),o===0&&(console.log("DraftStorage: Adding initial parcel"),t.click(),setTimeout(()=>{this.setupAutoSave()},500))}}}document.addEventListener("DOMContentLoaded",()=>{window.draftStorage=new l});
